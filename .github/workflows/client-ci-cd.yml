name: Client CI/CD

on:
  push:
    branches: [develop]
    paths:
      - 'client/**'
      - 'core/**'
      - '.github/workflows/client-ci-cd.yml'

jobs:
  ci-cd:
    runs-on: ubuntu-latest
    steps:
     - uses: actions/checkout@v4

     - name: Setup Node.js
       uses: actions/setup-node@v4
       with:
         node-version: '20'

     - name: Setup pnpm
       uses: pnpm/action-setup@v3
       with:
         version: '9'

     - name: Install Dependencies
       run: pnpm install --frozen-lockfile

     - name: Build Core Package
       working-directory: ./core
       run: pnpm build

     - name: Lint Client
       working-directory: ./client
       run: pnpm lint | true

     - name: Test Client
       working-directory: ./client
       run: pnpm test | true
       
     - name: Build Client
       working-directory: ./client
       run: pnpm build

     - name: Deploy to Server
       uses: appleboy/ssh-action@v1.0.0
       with:
         host: ${{ secrets.SSH_HOST }}
         username: mira
         key: ${{ secrets.SSH_PRIVATE_KEY }}
         script: |
           mkdir -p /home/mira/web30-stop-troublepainter/client/dist/
           scp -r /github/workspace/client/dist/* mira@${{ secrets.SSH_HOST }}:/home/mira/web30-stop-troublepainter/client/dist/
           docker cp /home/mira/web30-stop-troublepainter/client/dist/. troublepainter_nginx:/usr/share/nginx/html

